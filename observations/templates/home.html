{% extends "base.html" %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
{% if user.role == 'administrateur' and demandes_en_attente > 0 %}
<div class="alert alert-warning fade show" role="alert" id="alertDemandes" style="background-color: #fff3cd; border-color: #ffc107; color: #856404; position: relative; padding-right: 40px;">
    <strong><i class="fas fa-exclamation-triangle"></i> {{ demandes_en_attente }} demande(s) de compte en attente !</strong>
    <a href="{% url 'accounts:liste_utilisateurs' %}?valide=non" class="alert-link" style="color: #533f03; text-decoration: underline;">Voir les demandes</a>
    <button type="button" aria-label="Close" onclick="document.getElementById('alertDemandes').style.display='none';" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #8B0000; opacity: 1; font-weight: bold; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
{% endif %}

<h1>Bienvenue sur le suivi des observations</h1>
<p>Nombre total d'observateurs : {{ users_count }}</p>
<p>Nombre total d'observations : {{ observations_count }}</p>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h3>Observations</h3>
    </div>
    <div class="card-body">
        <ul>
            <li><a href="{% url 'observations_list' %}">Nouvelle observation</a></li>
            <li><a href="{% url 'liste_fiches_observations' %}">Liste des fiches d'observation</a></li>
        </ul>
    </div>
</div>

{% if fiches_en_edition %}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h3>Mes fiches en cours d'édition</h3>
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>N° Fiche</th>
                    <th>Espèce</th>
                    <th>Année</th>
                    <th>Statut</th>
                    <th>Dernière modification</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for fiche in fiches_en_edition %}
                <tr>
                    <td>{{ fiche.num_fiche }}</td>
                    <td>{{ fiche.espece.nom }}</td>
                    <td>{{ fiche.annee }}</td>
                    <td>
                        <span class="badge {% if fiche.etat_correction.statut == 'nouveau' %}bg-secondary{% elif fiche.etat_correction.statut == 'en_edition' %}bg-warning{% endif %}">
                            {{ fiche.etat_correction.get_statut_display }}
                        </span>
                    </td>
                    <td>{{ fiche.etat_correction.date_derniere_modification|date:"d/m/Y H:i" }}</td>
                    <td>
                        <a href="{% url 'modifier_observation' fiche_id=fiche.num_fiche %}" class="btn btn-sm btn-primary">Continuer</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if user.est_transcription or user.role == 'administrateur' %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h3>Transcription & Importation</h3>
    </div>
    <div class="card-body">
        <ul>
            <li><a href="{% url 'select_directory' %}">Transcription d'images</a></li>
            <li><a href="{% url 'accueil_importation' %}">Importation des transcriptions</a></li>
        </ul>
    </div>
</div>
{% endif %}

{% if user.is_authenticated and user.role == 'administrateur' %}
<div class="card mb-4">
    <div class="card-header bg-warning text-white">
        <h3>Administration</h3>
    </div>
    <div class="card-body">
        <ul>
            <li><a href="{% url 'accounts:liste_utilisateurs' %}">Gestion des utilisateurs</a></li>
            <li><a href="{% url 'accounts:creer_utilisateur' %}">Créer un nouvel utilisateur</a></li>
        </ul>
    </div>
</div>
{% endif %}

{% if user.is_authenticated and user.is_superuser and user.role != 'administrateur' %}
<div class="card">
    <div class="card-header bg-danger text-white">
        <h3>Accès d'urgence</h3>
    </div>
    <div class="card-body">
        <p><strong>Vous êtes un superutilisateur mais pas un administrateur dans le système de rôles.</strong></p>
        <p>Pour accéder aux fonctionnalités d'administration, vous devez d'abord vous promouvoir :</p>
        <a href="{% url 'accounts:promouvoir_administrateur' %}" class="btn btn-danger">Promouvoir en administrateur</a>
    </div>
</div>
{% endif %}
{% endblock %}
