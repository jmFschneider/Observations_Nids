{% extends "base.html" %}

{% block extra_css %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'Observations/css/styles.css' %}">
    <style>
        /* Style pour l'affichage séparé de la date et de l'heure en lecture seule */
        .observation-date-time {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .observation-time.time-unknown {
            background-color: #e9ecef;
            color: #6c757d;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
{% endblock %}


{% block content %}
<h2>Fiche Observation n°{{ fiche.num_fiche }}</h2>

<table class="fiche-table">
    <tr>
        <th>N° Fiche</th>
        <th>Observateur</th>
        <th>Espèce</th>
        <th>Année</th>
        <th>N° Personnel</th>
    </tr>
    <tr>
        <td>{{ fiche.num_fiche }}</td>
        <td>{{ fiche.observateur.first_name }} {{ fiche.observateur.last_name }}</td>
        <td>{{ fiche.espece.nom }}</td>
        <td>{{ fiche.annee }}</td>
        <td>{% if fiche.numero_personnel %}{{ fiche.numero_personnel }}{% else %}-{% endif %}</td>
    </tr>
</table>

<div class="lieu">
   <table class="localisation-table">
		<tr>
			<th>Commune</th>
			<td>
				{% if localisation.commune_saisie and localisation.commune_saisie != localisation.commune %}
					{{ localisation.commune_saisie }} → {{ localisation.commune }}
				{% elif localisation.commune_saisie %}
					{{ localisation.commune_saisie }}
				{% else %}
					{{ localisation.commune }}
				{% endif %}
			</td>
			<th>Département</th>
			<td>{{ localisation.departement }}</td>
		</tr>
		<tr>
			<th>Lieu-dit</th>
			<td>{{ localisation.lieu_dit }}</td>
			<th>Altitude</th>
			<td>{{ localisation.altitude }}</td>
		</tr>
		<tr>
			<th>Latitude</th>
			<td>{{ localisation.latitude }}</td>
			<th>Longitude</th>
			<td>{{ localisation.longitude }}</td>
		</tr>
	</table>
</div>		

<div class="localisation-container">
    <!-- Partie gauche : Paysage -->
    <div class="localisation-left">
        <div class="section-title">Paysage (200 à 500m)</div>
        <div class="section-content">{{ localisation.paysage }}</div>
    </div>
    <!-- Partie droite : Alentours -->
    <div class="localisation-right">
        <div class="section-title">Alentours (20 à 50m)</div>
        <div class="section-content">{{ localisation.alentours }}</div>
    </div>
</div>

<div class="nid">
	<!-- Tableau pour les informations du nid -->
		<h3>Description du Nid</h3>
	<table class="nid-table">
		<tr>
			<th style="width: 25%; text-align: center;">Nid précédent</th>
			<th style="width: 25%; text-align: center;">Nid suivant</th>
			<th style="width: 25%; text-align: center;">Hauteur du nid (cm)</th>
			<th style="width: 25%; text-align: center;">Hauteur du couvert (cm)</th>
		</tr>
		<tr>
			<td style="text-align: center; background-color: #f8f9fa;">
				{% if fiche.nid.fiche_precedente %}
					<a href="{% url 'observations:fiche_observation' fiche_id=fiche.nid.fiche_precedente.num_fiche %}" style="color: #0d6efd; text-decoration: none; font-weight: bold;">
						#{{ fiche.nid.fiche_precedente.num_fiche }}
					</a>
				{% else %}
					<span style="color: #6c757d;">-</span>
				{% endif %}
			</td>
			<td style="text-align: center; background-color: #f8f9fa;">
				{% if fiche.nids_suivants.exists %}
					{% for nid_suivant in fiche.nids_suivants.all %}
						<a href="{% url 'observations:fiche_observation' fiche_id=nid_suivant.fiche.num_fiche %}" style="color: #0d6efd; text-decoration: none; font-weight: bold;">
							#{{ nid_suivant.fiche.num_fiche }}
						</a>{% if not forloop.last %}, {% endif %}
					{% endfor %}
				{% else %}
					<span style="color: #6c757d;">-</span>
				{% endif %}
			</td>
			<td style="text-align: center;">{% if fiche.nid.hauteur_nid is not None %}{{ fiche.nid.hauteur_nid }}{% else %}-{% endif %}</td>
			<td style="text-align: center;">{% if fiche.nid.hauteur_couvert is not None %}{{ fiche.nid.hauteur_couvert }}{% else %}-{% endif %}</td>
		</tr>
	</table>
	<!-- Section Détails du Nid sous forme de cadre -->
	<div class="section-title">Détails du Nid</div>
	<div class="section-content">{{ fiche.nid.details_nid }}</div>
</div>
<!-- Résumé de l'observation en pleine largeur -->
        <!-- Tableau des observations -->
<div class="observations">
	<h3>Observations</h3>
	<div class="observations-table">
		<table>
			<thead>
				<tr>
					<th>Date et heure</th>
					<th>Nombre d'œufs</th>
					<th>Nombre de poussins</th>
					<th>Observations</th>
				</tr>
			</thead>
			<tbody>
				{% for observation in observations %}
				<tr>
					<td>
						<span class="observation-date-time">
							<span class="observation-date">{{ observation.date_observation|date:"d/m/Y" }}</span>
							<span class="observation-time {% if not observation.heure_connue %}time-unknown{% endif %}">{{ observation.date_observation|date:"H:i" }}</span>
						</span>
					</td>
					<td>{{ observation.nombre_oeufs }}</td>
					<td>{{ observation.nombre_poussins }}</td>
					<td>{{ observation.observations }}</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="4">Aucune observation enregistrée.</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
<div class="resume-container">
	<table>
		<thead>
			<tr>
				<th>Premier œuf pondu</th>
				<th>Premier poussin éclos</th>
				<th>Premier poussin volant</th>
				<th>Œufs pondus</th>
				<th>Œufs éclos</th>
				<th>Œufs non éclos</th>
				<th>Poussins</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>
					{% if fiche.resume.premier_oeuf_pondu_jour and fiche.resume.premier_oeuf_pondu_mois %}
						{{ fiche.resume.premier_oeuf_pondu_jour }}/{{ fiche.resume.premier_oeuf_pondu_mois }}
					{% else %}
						Non renseigné
					{% endif %}
				</td>
				<td>
					{% if fiche.resume.premier_poussin_eclos_jour and fiche.resume.premier_poussin_eclos_mois %}
						{{ fiche.resume.premier_poussin_eclos_jour }}/{{ fiche.resume.premier_poussin_eclos_mois }}
					{% else %}
						Non renseigné
					{% endif %}
				</td>
				<td>
					{% if fiche.resume.premier_poussin_volant_jour and fiche.resume.premier_poussin_volant_mois %}
						{{ fiche.resume.premier_poussin_volant_jour }}/{{ fiche.resume.premier_poussin_volant_mois }}
					{% else %}
						Non renseigné
					{% endif %}
				</td>
				<td>{{ fiche.resume.nombre_oeufs_pondus }}</td>
				<td>{{ fiche.resume.nombre_oeufs_eclos }}</td>
				<td>{{ fiche.resume.nombre_oeufs_non_eclos }}</td>
				<td>{{ fiche.resume.nombre_poussins }}</td>
			</tr>
		</tbody>
	</table>
</div>
<!-- Conteneur pour Causes de l'échec et Remarques -->
<div class="causes-remarques-container">
    <!-- Partie gauche : Causes de l'échec -->
    <div class="remarques-container">
		<table>
			<thead>
				<tr>
					<th>Description des causes d'échec</th>
				</tr>
			</thead>
			<tbody>
					<tr>
						<td>
							{% if fiche.causes_echec.description %}
								{{ fiche.causes_echec.description }}
							{% else %}
								Non renseigné
							{% endif %}
						</td>
					</tr>
			</tbody>
		</table>
    </div>

    <!-- Partie droite : Remarques -->
    <div class="remarques-container">
		<table>
			<thead>
				<tr>
					<th>Date</th>
					<th>Remarque</th>
				</tr>
			</thead>
			<tbody>
				{% for remarque in remarques %}
				<tr>
					<td>{{ remarque.date_remarque|date:"d/m/Y H:i" }}</td>
					<td>{{ remarque.remarque }}</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="2">Aucune remarque trouvée.</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
    </div>
</div>


{% endblock %}
