{% extends 'base.html' %}
{% load static %}

{% block title %}Administration des Donn√©es - Esp√®ces{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-database"></i> Administration des Donn√©es Taxonomiques</h1>
                <div>
                    <a href="{% url 'taxonomy:liste_especes' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour √† la liste
                    </a>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="card mb-4">
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-list fa-2x text-primary"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">Total esp√®ces</h6>
                                    <h3 class="mb-0 text-primary">{{ stats.total }}</h3>
                                </div>
                            </td>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-layer-group fa-2x text-success"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">Ordres</h6>
                                    <h3 class="mb-0 text-success">{{ stats.ordres }}</h3>
                                </div>
                            </td>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-sitemap fa-2x text-info"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">Familles</h6>
                                    <h3 class="mb-0 text-info">{{ stats.familles }}</h3>
                                </div>
                            </td>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-flag fa-2x text-warning"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">LOF</h6>
                                    <h3 class="mb-0 text-warning">{{ stats.source_lof }}</h3>
                                </div>
                            </td>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-database fa-2x text-secondary"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">TaxRef</h6>
                                    <h3 class="mb-0 text-secondary">{{ stats.source_taxref }}</h3>
                                </div>
                            </td>
                            <td class="text-center" style="width: 16.66%;">
                                <i class="fas fa-link fa-2x text-danger"></i>
                                <div class="mt-2">
                                    <h6 class="mb-0 text-muted">Avec liens</h6>
                                    <h3 class="mb-0 text-danger">{{ stats.avec_liens }}</h3>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Administration des donn√©es -->
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-tools"></i> Scripts d'administration
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> Ces actions permettent de charger et mettre √† jour les donn√©es de r√©f√©rence des esp√®ces d'oiseaux.
                        <strong>Attention :</strong> Ces op√©rations peuvent prendre plusieurs minutes.
                    </p>

                    <div class="row">
                        <!-- Charger esp√®ces depuis LOF -->
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-flag text-primary"></i> Liste Officielle de France (LOF)
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Charge les esp√®ces depuis la Liste Officielle des Oiseaux de France (CAF).
                                        <br><br>
                                        <strong>Source:</strong> Faune-France<br>
                                        <strong>Esp√®ces:</strong> ~577<br>
                                        <strong>Dur√©e:</strong> 10-30 secondes
                                    </p>
                                    <form method="post" action="{% url 'taxonomy:charger_especes_lof' %}" class="mt-3"
                                          onsubmit="return confirm('‚ö†Ô∏è Voulez-vous charger les esp√®ces depuis la LOF ?\n\nCela peut prendre quelques minutes.');">
                                        {% csrf_token %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="force" value="true" id="force-lof">
                                            <label class="form-check-label small" for="force-lof">
                                                <strong>Force</strong> (remplacer les donn√©es existantes)
                                            </label>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label class="form-label small mb-1">Limite (optionnel, pour test)</label>
                                            <input type="number" class="form-control form-control-sm" name="limit"
                                                   placeholder="Ex: 50" min="1">
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm w-100">
                                            <i class="fas fa-play-circle"></i> Lancer le chargement LOF
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Charger esp√®ces depuis TaxRef -->
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-info">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-database text-info"></i> TaxRef (MNHN/INPN)
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Charge depuis le r√©f√©rentiel taxonomique national (alternative √† LOF).
                                        <br><br>
                                        <strong>Source:</strong> INPN<br>
                                        <strong>Esp√®ces:</strong> ~574<br>
                                        <strong>Dur√©e:</strong> 1-3 minutes
                                    </p>
                                    <form method="post" action="{% url 'taxonomy:charger_especes_taxref' %}" class="mt-3"
                                          onsubmit="return confirm('‚ö†Ô∏è Voulez-vous charger les esp√®ces depuis TaxRef ?\n\nCela peut prendre quelques minutes.');">
                                        {% csrf_token %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="force" value="true" id="force-taxref">
                                            <label class="form-check-label small" for="force-taxref">
                                                <strong>Force</strong> (remplacer les donn√©es existantes)
                                            </label>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label class="form-label small mb-1">Version TaxRef (optionnel)</label>
                                            <input type="text" class="form-control form-control-sm" name="taxref_version"
                                                   placeholder="Ex: 18.0">
                                        </div>
                                        <button type="submit" class="btn btn-info btn-sm w-100">
                                            <i class="fas fa-play-circle"></i> Lancer le chargement TaxRef
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- R√©cup√©rer liens oiseaux.net (ASYNCHRONE) -->
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-success">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-link text-success"></i> Liens oiseaux.net
                                        <span class="badge bg-success ms-1" style="font-size: 0.6rem;">ASYNC</span>
                                    </h6>
                                    <p class="card-text small text-muted">
                                        R√©cup√®re automatiquement les URLs vers les fiches oiseaux.net.
                                        <br><br>
                                        <strong>Action:</strong> Enrichissement<br>
                                        <strong>Mode:</strong> Asynchrone (Celery)<br>
                                        <strong>Dur√©e:</strong> 5-15 minutes
                                    </p>
                                    <form method="post" action="{% url 'taxonomy:recuperer_liens_oiseaux_net' %}" class="mt-3"
                                          onsubmit="return confirm('üöÄ Lancer la r√©cup√©ration des liens en arri√®re-plan ?\n\nLa t√¢che s\'ex√©cutera de mani√®re asynchrone.\nVous pouvez suivre la progression dans Flower.');">
                                        {% csrf_token %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="force" value="true" id="force-liens">
                                            <label class="form-check-label small" for="force-liens">
                                                <strong>Force</strong> (remplacer les liens existants)
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="dry_run" value="true" id="dry-run-liens">
                                            <label class="form-check-label small" for="dry-run-liens">
                                                <strong>Dry-run</strong> (simulation sans enregistrement)
                                            </label>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label class="form-label small mb-1">Limite (optionnel, pour test)</label>
                                            <input type="number" class="form-control form-control-sm" name="limit"
                                                   placeholder="Ex: 50" min="1">
                                        </div>
                                        <div class="form-group mb-2">
                                            <label class="form-label small mb-1">D√©lai entre requ√™tes (secondes)</label>
                                            <input type="number" class="form-control form-control-sm" name="delay"
                                                   value="1.0" step="0.1" min="0.5" max="5.0">
                                        </div>
                                        <button type="submit" class="btn btn-success btn-sm w-100">
                                            <i class="fas fa-rocket"></i> Lancer en arri√®re-plan
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mb-0 mt-2">
                        <i class="fas fa-lightbulb"></i> <strong>Ordre recommand√© pour une nouvelle installation :</strong>
                        <ol class="mb-0 mt-2 small">
                            <li>Charger les esp√®ces depuis la LOF (avec force) - <em>Recommand√©</em></li>
                            <li>Ou charger depuis TaxRef si vous pr√©f√©rez cette source</li>
                            <li>R√©cup√©rer les liens oiseaux.net pour enrichir les donn√©es</li>
                        </ol>
                        <div class="mt-2 small">
                            <strong>Note :</strong> La LOF est recommand√©e car elle est plus rapide et sp√©cifique aux oiseaux de France.
                            TaxRef est plus complet mais inclut toutes les esp√®ces animales (t√©l√©chargement manuel requis).
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Ouvrir automatiquement Flower si un task_id est pr√©sent dans l'URL
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('task_id');

    if (taskId) {
        // Ouvrir Flower dans un nouvel onglet
        const flowerUrl = `http://${window.location.hostname}:5555/task/${taskId}`;
        window.open(flowerUrl, '_blank', 'noopener,noreferrer');

        // Nettoyer l'URL pour √©viter de rouvrir Flower au refresh
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
});
</script>
{% endblock %}
