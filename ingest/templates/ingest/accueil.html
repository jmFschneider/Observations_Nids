{% extends "base.html" %}
{% load static %}

{% block title %}Importation des transcriptions{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="fas fa-file-import"></i> Système d'importation des transcriptions</h1>

    <!-- Lien vers le résumé -->
    <div class="mb-4">
        <a href="{% url 'ingest:resume_importation' %}" class="btn btn-outline-info">
            <i class="fas fa-chart-bar"></i> Voir le résumé des importations
        </a>
    </div>

    <!-- INDICATEUR DE PROGRESSION - STEPPER -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-tasks"></i> Workflow d'importation</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i> <strong>Processus en 5 étapes</strong> - Suivez ces étapes dans l'ordre pour importer vos transcriptions.
            </div>

            <!-- ÉTAPE 1: Importer JSON -->
            <div class="workflow-step {% if total_transcriptions > 0 %}completed{% else %}active{% endif %} mb-4">
                <div class="d-flex align-items-start">
                    <div class="step-number">
                        {% if total_transcriptions > 0 %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% else %}
                            <span class="badge badge-primary" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">1</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-file-upload"></i> Importer les fichiers JSON
                            </h5>
                            {% if total_transcriptions > 0 %}
                                <span class="badge bg-success">{{ total_transcriptions }} fichier{{ total_transcriptions|pluralize }} importé{{ total_transcriptions|pluralize }}</span>
                            {% else %}
                                <span class="badge bg-secondary">Aucun fichier</span>
                            {% endif %}
                        </div>
                        <p class="text-muted mb-2">
                            Importez les fichiers JSON générés par la transcription OCR dans la base de données.
                        </p>
                        <a href="{% url 'ingest:importer_json' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-upload"></i> Importer JSON
                        </a>
                    </div>
                </div>
            </div>

            <div class="workflow-separator"></div>

            <!-- ÉTAPE 2: Extraire espèces -->
            <div class="workflow-step {% if especes_candidates > 0 %}completed{% elif transcriptions_non_traitees > 0 %}active{% else %}disabled{% endif %} mb-4">
                <div class="d-flex align-items-start">
                    <div class="step-number">
                        {% if especes_candidates > 0 %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% elif transcriptions_non_traitees > 0 %}
                            <span class="badge badge-warning" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">2</span>
                        {% else %}
                            <span class="badge badge-secondary" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">2</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-search"></i> Extraire les espèces
                            </h5>
                            {% if especes_candidates > 0 %}
                                <span class="badge bg-success">{{ especes_candidates }} espèce{{ especes_candidates|pluralize }} extraite{{ especes_candidates|pluralize }}</span>
                            {% elif transcriptions_non_traitees > 0 %}
                                <span class="badge bg-warning">{{ transcriptions_non_traitees }} transcription{{ transcriptions_non_traitees|pluralize }} à traiter</span>
                            {% else %}
                                <span class="badge bg-secondary">En attente de l'étape 1</span>
                            {% endif %}
                        </div>
                        <p class="text-muted mb-2">
                            Analyse les JSON pour extraire les espèces (les observateurs sont créés automatiquement).
                        </p>
                        {% if especes_candidates > 0 %}
                            <span class="text-success">
                                <i class="fas fa-check-circle"></i> Extraction terminée
                            </span>
                        {% elif transcriptions_non_traitees > 0 %}
                            <a href="{% url 'ingest:extraire_candidats' %}" class="btn btn-sm btn-warning">
                                <i class="fas fa-magic"></i> Extraire les espèces
                            </a>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled title="Importez d'abord des fichiers JSON">
                                <i class="fas fa-lock"></i> Extraire les espèces
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="workflow-separator"></div>

            <!-- ÉTAPE 3: Valider espèces -->
            <div class="workflow-step {% if especes_non_validees == 0 and especes_candidates > 0 %}completed{% elif especes_non_validees > 0 %}active{% else %}disabled{% endif %} mb-4">
                <div class="d-flex align-items-start">
                    <div class="step-number">
                        {% if especes_non_validees == 0 and especes_candidates > 0 %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% elif especes_non_validees > 0 %}
                            <span class="badge badge-info" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">3</span>
                        {% else %}
                            <span class="badge badge-secondary" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">3</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-check-double"></i> Valider les espèces candidates
                            </h5>
                            {% if especes_non_validees > 0 %}
                                <span class="badge bg-warning">{{ especes_non_validees }} espèce{{ especes_non_validees|pluralize }} à valider</span>
                            {% elif especes_candidates > 0 %}
                                <span class="badge bg-success">Toutes validées</span>
                            {% else %}
                                <span class="badge bg-secondary">En attente de l'étape 2</span>
                            {% endif %}
                        </div>
                        <p class="text-muted mb-2">
                            Associez chaque espèce candidate trouvée dans les transcriptions à une espèce validée de la base de données.
                        </p>
                        {% if especes_non_validees == 0 and especes_candidates > 0 %}
                            <span class="text-success">
                                <i class="fas fa-check-circle"></i> Toutes les espèces sont validées ({{ especes_validees }}/{{ especes_candidates }})
                            </span>
                        {% elif especes_non_validees > 0 %}
                            <a href="{% url 'ingest:liste_especes_candidates' %}" class="btn btn-sm btn-info">
                                <i class="fas fa-cog"></i> Gérer les espèces ({{ especes_validees }}/{{ especes_candidates }})
                            </a>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled title="Extrayez d'abord les candidats">
                                <i class="fas fa-lock"></i> Gérer les espèces
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="workflow-separator"></div>

            <!-- ÉTAPE 4: Préparer importations -->
            <div class="workflow-step {% if transcriptions_non_traitees == 0 and total_transcriptions > 0 %}completed{% elif especes_validees > 0 and transcriptions_non_traitees > 0 %}active{% else %}disabled{% endif %} mb-4">
                <div class="d-flex align-items-start">
                    <div class="step-number">
                        {% if transcriptions_non_traitees == 0 and total_transcriptions > 0 %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% elif especes_validees > 0 and transcriptions_non_traitees > 0 %}
                            <span class="badge badge-warning" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">4</span>
                        {% else %}
                            <span class="badge badge-secondary" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">4</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs"></i> Préparer les importations
                            </h5>
                            {% if transcriptions_non_traitees > 0 %}
                                <span class="badge bg-warning">{{ transcriptions_non_traitees }} transcription{{ transcriptions_non_traitees|pluralize }} à préparer</span>
                            {% elif total_importations > 0 %}
                                <span class="badge bg-success">{{ total_importations }} importation{{ total_importations|pluralize }} créée{{ total_importations|pluralize }}</span>
                            {% elif especes_validees > 0 %}
                                <span class="badge bg-info">Prêt à préparer</span>
                            {% else %}
                                <span class="badge bg-secondary">En attente de l'étape 3</span>
                            {% endif %}
                        </div>
                        <p class="text-muted mb-2">
                            Créez les fiches d'importation en associant les données transcrites aux espèces et observateurs validés.
                            {% if importations_completees > 0 and transcriptions_non_traitees > 0 %}
                            <br><strong class="text-warning">{{ importations_completees }} déjà créée{{ importations_completees|pluralize }}, {{ transcriptions_non_traitees }} reste{{ transcriptions_non_traitees|pluralize:"nt" }} à préparer.</strong>
                            {% endif %}
                        </p>
                        {% if especes_validees > 0 and transcriptions_non_traitees > 0 %}
                            <a href="{% url 'ingest:preparer_importations' %}" class="btn btn-sm btn-warning">
                                <i class="fas fa-play"></i> Préparer les {{ transcriptions_non_traitees }} transcription{{ transcriptions_non_traitees|pluralize }} restante{{ transcriptions_non_traitees|pluralize }}
                            </a>
                        {% elif transcriptions_non_traitees == 0 and total_importations > 0 %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> Toutes les transcriptions ont été préparées ({{ total_importations }})</span>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled title="Validez d'abord les espèces ou importez des transcriptions">
                                <i class="fas fa-lock"></i> Préparer les importations
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="workflow-separator"></div>

            <!-- ÉTAPE 5: Finaliser importations -->
            <div class="workflow-step {% if importations_completees > 0 %}completed{% elif importations_en_attente > 0 %}active{% else %}disabled{% endif %}">
                <div class="d-flex align-items-start">
                    <div class="step-number">
                        {% if importations_completees > 0 %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% elif importations_en_attente > 0 %}
                            <span class="badge badge-danger" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">5</span>
                        {% else %}
                            <span class="badge badge-secondary" style="font-size: 1.5rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">5</span>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-check"></i> Finaliser les importations
                            </h5>
                            {% if importations_en_attente > 0 %}
                                <span class="badge bg-danger">{{ importations_en_attente }} à finaliser</span>
                            {% elif importations_completees > 0 %}
                                <span class="badge bg-success">{{ importations_completees }} terminée{{ importations_completees|pluralize }}</span>
                            {% else %}
                                <span class="badge bg-secondary">En attente de l'étape 4</span>
                            {% endif %}
                        </div>
                        <p class="text-muted mb-2">
                            Importez définitivement les observations dans la base de données principale.
                        </p>
                        {% if importations_en_attente > 0 %}
                            <a href="{% url 'ingest:liste_importations' %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-list"></i> Gérer les importations ({{ importations_en_attente }} en attente)
                            </a>
                        {% elif importations_completees > 0 %}
                            <a href="{% url 'ingest:liste_importations' %}" class="btn btn-sm btn-info">
                                <i class="fas fa-list"></i> Voir les importations terminées
                            </a>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled title="Préparez d'abord les importations">
                                <i class="fas fa-lock"></i> Gérer les importations
                            </button>
                        {% endif %}
                        {% if importations_erreur > 0 %}
                            <span class="badge bg-warning ms-2">{{ importations_erreur }} en erreur</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STATISTIQUES DÉTAILLÉES (repliable) -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
                <button class="btn btn-link text-white text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#statsDetails">
                    <i class="fas fa-chart-pie"></i> Statistiques détaillées
                    <i class="fas fa-chevron-down float-end"></i>
                </button>
            </h5>
        </div>
        <div id="statsDetails" class="collapse">
            <div class="card-body">
                <div class="row">
                    <!-- Transcriptions -->
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-file-alt"></i> Transcriptions</h6>
                        <ul class="list-unstyled">
                            <li>Total : <strong>{{ total_transcriptions }}</strong></li>
                            <li>Traitées : <strong>{{ transcriptions_traitees }}</strong></li>
                            <li>En attente : <strong>{{ transcriptions_non_traitees }}</strong></li>
                        </ul>
                    </div>

                    <!-- Espèces -->
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-dove"></i> Espèces</h6>
                        <ul class="list-unstyled">
                            <li>Candidates : <strong>{{ especes_candidates }}</strong></li>
                            <li>Validées : <strong>{{ especes_validees }}</strong></li>
                            <li>En attente : <strong>{{ especes_non_validees }}</strong></li>
                        </ul>
                    </div>

                    <!-- Observateurs -->
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-users"></i> Observateurs</h6>
                        <ul class="list-unstyled">
                            <li>Créés (transcription) : <strong>{{ observateurs_transcription }}</strong></li>
                            <li>Total : <strong>{{ total_observateurs }}</strong></li>
                        </ul>
                    </div>
                </div>

                <div class="row">
                    <!-- Importations -->
                    <div class="col-md-6 mb-3">
                        <h6><i class="fas fa-tasks"></i> Importations</h6>
                        <ul class="list-unstyled">
                            <li>En attente : <strong>{{ importations_en_attente }}</strong></li>
                            <li>En erreur : <strong>{{ importations_erreur }}</strong></li>
                            <li>Terminées : <strong>{{ importations_completees }}</strong></li>
                        </ul>
                    </div>

                    <!-- Communes -->
                    <div class="col-md-6 mb-3">
                        <h6><i class="fas fa-map-marker-alt"></i> Communes</h6>
                        <ul class="list-unstyled">
                            <li>Trouvées (transcription) : <strong>{{ communes_transcription|default:"0" }}</strong></li>
                            <li>Dans l'ensemble des fiches : <strong>{{ communes_fiches|default:"0" }}</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .workflow-step {
        padding: 20px;
        border-left: 4px solid #dee2e6;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .workflow-step.active {
        border-left-color: #ffc107;
        background-color: #fff3cd;
    }

    .workflow-step.completed {
        border-left-color: #28a745;
        background-color: #d4edda;
    }

    .workflow-step.disabled {
        border-left-color: #6c757d;
        background-color: #e9ecef;
        opacity: 0.6;
    }

    .workflow-separator {
        width: 2px;
        height: 20px;
        background-color: #dee2e6;
        margin-left: 40px;
    }

    .step-number {
        min-width: 40px;
    }
</style>
{% endblock %}
